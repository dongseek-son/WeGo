<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="GoalDao">
	
<insert id="insertGoal" parameterType="GoalVO">
	INSERT	INTO GL (
						GL_ID
						, TTL
						, DTL
						<if test="parentGoalId != null">
							, PRNT_GL_ID
						</if>
						, EML
						, IS_SCCSS
						, IS_BLCK
						, WRT_DT
						, IS_OPN
						, IS_DLT
						, IS_DRBLTY
						, IS_BST
						, MDFY_DT
						, MNG_ID
					)
	VALUES (
				'MS-' || TO_CHAR(SYSDATE, 'YYYYMMDDHH24') || '-' || LPAD(GL_ID_SEQ.NEXTVAL, 6, '0')
				, #{title}
				, #{detail}
				<if test="parentGoalId != null">
					, #{parentGoalId}
				</if>
				, #{email}
				, 0
				, 0
				, SYSDATE
				, #{isOpen}
				, 0
				, #{isDurablity}
				, 0
				, SYSDATE
				, #{mongoId}
	)
</insert>

<select id="selectGoal" parameterType="string" resultType="GoalVO">
	SELECT	GL_ID id
			, TTL title
			, DTL detail
			, PRNT_GL_ID parentGoalId
			, EML email
			, IS_SCCSS isSuccess
			, IS_BLCK isBlock
			, WRT_DT writeDate
			, IS_OPN isOpen
			, IS_DLT isDetail
			, IS_DRBLTY isDurablity
			, IS_BST isBoast
			, MDFY_DT modifyDate
			, MNG_ID mongoId
	FROM	GL
	WHERE	GL_ID = #{id}
</select>

<select id="selectParentGoal" parameterType="string" resultType="GoalVO">
	SELECT	GL_ID id
			, TTL title
			, DTL detail
			, PRNT_GL_ID parentGoalId
			, EML email
			, IS_SCCSS isSuccess
			, IS_BLCK isBlock
			, WRT_DT writeDate
			, IS_OPN isOpen
			, IS_DLT isDetail
			, IS_DRBLTY isDurablity
			, IS_BST isBoast
			, MDFY_DT modifyDate
			, MNG_ID mongoId
	FROM	GL
	WHERE	GL_ID = (
						SELECT	PRNT_GL_ID
						FROM	GL
						WHERE	GL_ID = #{id}
					)
</select>

<select id="selectChildrenGoalList" parameterType="string" resultType="GoalVO">
	SELECT	GL_ID id
			, TTL title
			, DTL detail
			, PRNT_GL_ID parentGoalId
			, EML email
			, IS_SCCSS isSuccess
			, IS_BLCK isBlock
			, WRT_DT writeDate
			, IS_OPN isOpen
			, IS_DLT isDetail
			, IS_DRBLTY isDurablity
			, IS_BST isBoast
			, MDFY_DT modifyDate
			, MNG_ID mongoId
	FROM	GL
	WHERE	PRNT_GL_ID = #{id}
</select>

<select id="selectLatestModifyGoalByEmail" parameterType="string" resultType="GoalVO">
	SELECT	GL_ID id
			, TTL title
			, DTL detail
			, PRNT_GL_ID parentGoalId
			, EML email
			, IS_SCCSS isSuccess
			, IS_BLCK isBlock
			, WRT_DT writeDate
			, IS_OPN isOpen
			, IS_DLT isDetail
			, IS_DRBLTY isDurablity
			, IS_BST isBoast
			, MDFY_DT modifyDate
			, MNG_ID mongoId
	FROM	(
				SELECT	ROWNUM
						, GL_ID
						, TTL
						, DTL
						, PRNT_GL_ID
						, EML
						, IS_SCCSS
						, IS_BLCK
						, WRT_DT
						, IS_OPN
						, IS_DLT
						, IS_DRBLTY
						, IS_BST
						, MDFY_DT
						, MNG_ID
				FROM	GL
				WHERE	EML = #{email}
				ORDER	BY MDFY_DT DESC
	)
	WHERE	ROWNUM = 1
</select>

<select id="selectGoalListByLevel" parameterType="map" resultType="GoalVO">
	SELECT  GL_ID id
			, TTL title
			, DTL detail
			, PRNT_GL_ID parentGoalId
			, EML email
			, IS_SCCSS isSuccess
			, IS_BLCK isBlock
			, WRT_DT writeDate
			, IS_OPN isOpen
			, IS_DLT isDetail
			, IS_DRBLTY isDurablity
			, IS_BST isBoast
			, MDFY_DT modifyDate
			, MNG_ID mongoId
	FROM    (
	            SELECT  LEVEL lv
	                    , GL_ID id
						, TTL title
						, DTL detail
						, PRNT_GL_ID parentGoalId
						, EML email
						, IS_SCCSS isSuccess
						, IS_BLCK isBlock
						, WRT_DT writeDate
						, IS_OPN isOpen
						, IS_DLT isDetail
						, IS_DRBLTY isDurablity
						, IS_BST isBoast
						, MDFY_DT modifyDate
						, MNG_ID mongoId
	            FROM    GL
	            WHERE	EML = #{email}
	            START   WITH PRNT_GL_ID is null
	            CONNECT BY PRIOR GL_ID = PRNT_GL_ID
	)
	WHERE LV = #{level}
</select>
	
</mapper>